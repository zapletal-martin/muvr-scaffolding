<!DOCTYPE html>
<html>
<head>
  <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="//code.jquery.com/jquery-2.1.3.min.js" charset="utf-8"></script>
  <script src="/js/ZeroClipboard.js" charset="utf-8"></script>

  <style>
    body {
      font-family: Helvetica, sans-serif;
      font-size: 10pt;
    }

    div {
      display: inline;
    }

    .axis path {
      fill: none;
      stroke: #777;
      shape-rendering: crispEdges;
    }

    .axis text {
      font-family: Helvetica, sans-serif;
      font-size: 10pt;
    }

    svg {
      display: block;
      margin-bottom: 10pt;
    };
  </style>
  <script>
    function chartThreed(id, data) {
      var vis = d3.select(id),
          WIDTH = 1000,
          HEIGHT = 500,
          MARGINS = {
              top: 20,
              right: 20,
              bottom: 20,
              left: 50
          },
          xScale = d3.scale.linear().range([MARGINS.left, WIDTH - MARGINS.right]).domain([0, data.length]),
          yScale = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([-2000, 2000]),
          xAxis = d3.svg.axis().scale(xScale),
          yAxis = d3.svg.axis().scale(yScale).orient("left");

      vis.append("svg:g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")
          .call(xAxis);

      vis.append("svg:g")
          .attr("class", "y axis")
          .attr("transform", "translate(" + (MARGINS.left) + ",0)")
          .call(yAxis);

      var lines = [
        { "color":"red",   "legend":"x", "values": data.map(function(e, i) { return { "x":i, "y":e.x, }; }) },
        { "color":"green", "legend":"y", "values": data.map(function(e, i) { return { "x":i, "y":e.y, }; }) },
        { "color":"blue",  "legend":"z", "values": data.map(function(e, i) { return { "x":i, "y":e.z, }; }) }
      ];

      var lineGen = d3.svg.line()
          .x(function(d) { return xScale(d.x); })
          .y(function(d) { return yScale(d.y); })
          .interpolate("basis");
      var legend = vis.append("g").attr("transform", "translate(" + (WIDTH - 30) + ",20)");

      lines.forEach(function(line, idx) {
        vis.append('svg:path')
            .attr('d', lineGen(line.values))
            .attr('stroke', line.color)
            .attr('stroke-width', 2)
            .attr('fill', 'none');

        legend.append('text').attr('y', idx * 20).style('fill', line.color).text(line.legend);
      });
    }

    function updateStats(example) {
      $("#correct").text(example.correct.sets[0].exercise);
      $("#classified").text("[]");

      $("#sensors").empty();
      example.fusedSensorData.forEach(function(x) {
        var id = x.deviceId + "-" + x.sensorType;
        var header = $('<h3></h3>').text("Device " + x.deviceId + ", sensor " + x.sensorType);
        var threed = $('<svg id="threed-' + id + '" width="1000" height="500"></svg>');
        var matlab = $('<button id="matlab-' + id + '">MATLAB</button>');
        matlab.click(function() {
          console.log("ML");
          ZeroClipboard.setData("text/plain", "Copy me!");
        });
        $('#sensors').append(header);
        $('#sensors').append(threed);
        $('#sensors').append(matlab);
        chartThreed('#threed-' + id, x.data);
      });
    }

    var host = window.document.location.host.replace(/:.*/, '');
    var ws = new WebSocket('ws://' + host + ':8080/exercise');
    ws.onmessage = function (event) {
      updateStats(JSON.parse(event.data));
    };

    ZeroClipboard.config( { swfPath: "/swf/ZeroClipboard.swf" } );
    ZeroClipboard.setData("text/plain", "Copy me!");
  </script>
</head>
<body>
  <h1>Muvr Development Scaffolding</h1>
  <div id='example'>
    <h3>Classification</h3>
    <p>Classified: <span id="classified"></span></p>
    <p>Correct: <span id="correct"></span></p>
    <div id="sensors">
    </div>
  </div>
</body>
</html>
